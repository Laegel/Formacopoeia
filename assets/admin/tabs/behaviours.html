<template>
    <div class="fc-tab-content">
        <h2>{{translate 'behaviours.title'}}</h2>
        <div class="container">
            <select id="fc-select-behaviour">
                {{#each behaviours}}
                    <option value="{{name}}">{{options.label}}</option>
                {{/each}}
            </select>
            <span id="fc-add-behaviour" class="button dashicons dashicons-plus"></span>
        </div>
        <div class="rows" data-renderer-part="behaviourRows"> 
            {{#each2 formBehaviours}}
                <div class="fc-behaviour" data-row="{{$row}}">
                    <div class="fc-behaviour-options fc-options-container">
                        <h2>{{displayLabel data.name}}</h2>
                        <span class="fc-remove button danger dashicons dashicons-trash"></span>
                        <span class="fc-accordion button dashicons dashicons-arrow-down-alt2"></span>
                    </div>
                    <div class="row container">
                        <div class="fc-behaviour-container" data-behaviour="{{data.name}}"></div>
                    </div>
                </div>
            {{/each2}}
        </div>
    </div>
</template>

<script>
{
    onInit: function () {
        return {
            behaviours: formacopoeia.behaviours
        };
    },
    onActive: function () {
        var _this = this;
        var selectBehaviour = select('#fc-select-behaviour');
        var addBehaviour = select('#fc-add-behaviour');
        var behaviours;
        addBehaviour.on('click', function (e) {
            formacopoeia.currentForm.tabs.behaviours = formacopoeia.currentForm.tabs.behaviours || [];
            formacopoeia.currentForm.tabs.behaviours.push({
                name: selectBehaviour.value
            });
            _this.rerenderBehavioursList();
            _this.toggleBehaviourContent(select('.fc-behaviour:last-child'));
        });
        this.rerenderBehavioursList();
        this.manageButtons();
    },
    rerenderBehavioursList: function () {
        select('.rows').innerHTML = renderer(select('[data-template-part="behaviourRows"]').innerHTML, {
            formBehaviours: formacopoeia.currentForm.tabs.behaviours,
            behaviours: formacopoeia.behaviours
        });
        selectAll('.fc-behaviour-container').forEach(function (element) {
            element.innerHTML = renderer(select('[data-template-behaviour="' + element.dataset.behaviour + '"]').innerHTML); //TODO
        });
    },
    removeBehaviour: function (element) {
        formacopoeia.currentForm.tabs.behaviours.splice(element.dataset.row, 1);
        element.remove();
    },
    toggleBehaviourContent: function (element) {
        var toggleClasses = function (el) {
            el.classList.toggle('dashicons-arrow-down-alt2');
            el.classList.toggle('dashicons-arrow-up-alt2');
        };
        selectAll('.fc-behaviour').forEach(function (item) {
            if (item === element) {
                return;
            }
            var toggler = select('.fc-accordion', item);
            toggler.classList.add('dashicons-arrow-down-alt2');
            toggler.classList.remove('dashicons-arrow-up-alt2');
            select('.container', item).removeAttribute('style');
        });
        toggleClasses(select('.fc-accordion', element));
        var container = select('.container', element);
        if (!container.style.display) {
            container.style.display = 'block';
        }
        else {
            container.removeAttribute('style');
        }
    },
    manageButtons: function () {
        var _this = this;
        select('.fc-tab-content').on('click', function (e) {
            if (e.target.classList.contains('fc-remove')) {
                _this.removeBehaviour(e.target.closest('.fc-behaviour'));
            }
            if (e.target.classList.contains('fc-accordion')) {
                _this.toggleBehaviourContent(e.target.closest('.fc-behaviour'));
            }
        });
    }
};
</script>

<style>

</style>